<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Vignette Author" />

<meta name="date" content="2022-09-01" />

<title>Kalman Filter for State Space Models</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Kalman Filter for State Space Models</h1>
<h4 class="author">Vignette Author</h4>
<h4 class="date">2022-09-01</h4>



<p><code>kalmanfilter</code> is an <code>Rcpp</code> implementation of
the multivariate Kalman filter for state space models that can handle
missing values and exogenous data in the observation and state
equations.</p>
<div id="the-state-space-model" class="section level1">
<h1>The State Space Model</h1>
<p>The state space model is written as <span class="math display">\[
Y_t = A + H \beta + B^o X^o_t + e_t, e_t \sim N(0, R)\\
\beta_t = D + F \beta_{t-1} + B^s X^s_t + u_t, u_t \sim N(0, Q)
\]</span> where the first equation is the observation equation and the
second equation is the transition equation. <span class="math inline">\(H\)</span> is the observation matrix, <span class="math inline">\(X^o_t\)</span> is optional exogenous data in the
observation equation, and <span class="math inline">\(e_t \sim N(0,
\sigma_e^2)\)</span> is the observation error, and <span class="math inline">\(R\)</span> is the observation error-covariance
matrix. <span class="math inline">\(\beta_t\)</span> is the vector of
the unobserved components <span class="math inline">\(F\)</span> is the
transition matrix, and <span class="math inline">\(Q\)</span> is the
transition error-covariance matrix. <span class="math inline">\(X^s_t\)</span> is optional exogenous data in the
state equation.</p>
</div>
<div id="the-kalman-filter" class="section level1">
<h1>The Kalman Filter</h1>
<p>To estimate the unobserved components (<span class="math inline">\(T_t, C_t, S_t\)</span>, and <span class="math inline">\(D_t\)</span>), the Kalman filter is utilized. The
Kalman filter is a forward two-stage procedure that is the optimal
linear filter based on the multivariate normal distribution. The
“forwardness” of the filter means that it uses only data up to time
<span class="math inline">\(t\)</span> to make an inference on the
unobserved components at time <span class="math inline">\(t\)</span> and
does peak into the future to make that inference.</p>
<div id="prediction-stage" class="section level2">
<h2>Prediction Stage</h2>
<p>The first stage is the prediction stage, which makes predictions on
the unobserved components based on information up to time <span class="math inline">\(t-1\)</span>. This stage is made up of four
equations, the first is the prediction of the unobserved components
based on its time series properties</p>
<p><span class="math display">\[
B_{t|t-1} = \bar{D} + F \beta_{t-1|t-1} + B^s X^s_t
\]</span></p>
<p>Second, is the prediction of the covariance matrix of the unobserved
components</p>
<p><span class="math display">\[
P_{t|t-1} = F P_{t_1|t-1} F^{\prime} + Q
\]</span></p>
<p>Third, is the prediction error of the time series of interest</p>
<p><span class="math display">\[
\eta_{t|t-1} = Y_t - (A + H \beta_{t|t-1} + B^o X^o_t)
\]</span></p>
<p>And finally, we have the variance of the prediction error</p>
<p><span class="math display">\[
f_{t|t-1} = H P_{t|t-1} H^{\prime} + R
\]</span></p>
</div>
<div id="updating-stage" class="section level2">
<h2>Updating Stage</h2>
<p>The second stage is the updating stage, which makes predictions based
on all information up to time <span class="math inline">\(t\)</span>. It
consists of three equations. The first equation is the prediction of the
unobserved components based on the the full information set</p>
<p><span class="math display">\[
\beta_{t|t} = B_{t|t-1} + K_t \eta_{t|t-1}
\]</span> where <span class="math inline">\(K_t\)</span> is the Kalman
gain, which determines the optimal weight to give new information in
making predictions about <span class="math inline">\(\beta_t\)</span>
and is the second equation</p>
<p><span class="math display">\[
K_t = P_{t|t-1} H^{\prime} f_{t|t-1}^{-1}
\]</span> The last equation is the updating of the covariance matrix of
the unobserved components</p>
<p><span class="math display">\[
P_{t|t} = P_{t|t-1} - K_t H^{\prime} P_{t|t-1}
\]</span> The seven equations above, make up the full Kalman filter
routine. If <span class="math inline">\(Y_t\)</span> is missing for any
observation, then</p>
<p><span class="math display">\[
B_{t|t} = B_{t|t-1} \\
P_{t|t} = P_{t|t-1} \\
K_t = 0 \\
f_{t|t-1} = \infty
\]</span></p>
</div>
<div id="kalman-smoothing" class="section level2">
<h2>Kalman Smoothing</h2>
<p>Once the Kalman filter is applied to the data, a smoothing procedure
can applied in the backward direction to make a better inference of the
unobserved components based on the entire data set. Unlike the filter,
the smoother does peak into the future to make an inference on the
unobserved components at time <span class="math inline">\(t\)</span>.
This procedure consists of only two equations.</p>
<p>The first equation updates the prediction of the unobserved
components based on all the available information</p>
<p><span class="math display">\[
\beta_{t|T} = \beta_{t|t} + P_{t|t} F^{\prime} P_{t|t}^{-1}
(\beta_{t+1|T} - \beta_{t+1|t})
\]</span></p>
<p>The second equation updates the covariance matrix of the unobserved
components based on all the available information</p>
<p><span class="math display">\[
P_{t|T} = P_{t|t} + P_{t|t} F^{\prime} P_{t+1|t}^{-1} (P_{t+1|T} -
P_{t+1|t}) P_{t+1|t}^{-1 \prime} F P_{t|t}^{\prime}
\]</span></p>
</div>
</div>
<div id="implementation" class="section level1">
<h1>Implementation</h1>
<p>To use the package for maximum likelihood estimation, use the
function <code>kalman_lik</code> as</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>lnl <span class="ot">=</span> <span class="fu">kalman_lik</span>(ssm, yt, Xo, Xs, w)</span></code></pre></div>
<p>where <code>ssm</code> is a list object with matrices that describes
the state space model. <code>ssm</code> should contain matrices named
“B0” for the initial guess of the unobserved components, “P0” for the
initial guess of the unobserved components covariance matrix, “Dm” for
the constant in the state equation, “Am” for the constant in the
observation equation, “Fm” for the state equation transition matrix,
“Hm” for the observation matrix in the observation equation, “Qm” for
the covariance matrix of the errors in the state equation, “Rm” for the
covariance matrix of the errors in the observation equation, “betaO” for
the coefficients on the exogenous data in the observation matrix, and
“betaS” for the coefficients on the exogenous data in the state
matrix.</p>
<p><code>yt</code> is an <code>N_yxT</code> matrix, where
<code>N_y</code> is the number of variables and <code>T</code> is the
number of time periods.</p>
<p><code>Xo</code> is an <code>M_oxT</code> matrix of exogenous data in
the observation equation, where <code>M_o</code> is the number of
exogenous observation variables.</p>
<p><code>Xs</code> is an <code>M_sxT</code> matrix of exogenous data in
the state equation, where <code>M_s</code> is the number of exogenous
state variables.</p>
<p><code>w</code> is an <code>Tx1</code> matrix of weights.</p>
<p><code>ssm[[&quot;B0&quot;]]</code>, <code>ssm[[&quot;P0&quot;]]</code>,
<code>ssm[[&quot;Qm&quot;]]</code> are <code>N_{\beta}xN_{\beta}</code> matrix,
where <code>N_{\beta}</code> is the number of unobserved variables in
the state equation.</p>
<p><code>ssm[[&quot;Dm&quot;]]</code> is an <code>N_{\beta}x1</code> matrix.</p>
<p><code>ssm[[&quot;Am&quot;]]</code> is an <code>N_yx1</code> matrix.</p>
<p><code>ssm[[&quot;Fm&quot;]]</code> is an <code>N_{\beta}xP</code> matrix, where
<code>P</code> is the number of lags in the state equation.</p>
<p><code>ssm[[&quot;Hm&quot;]]</code> is an <code>N_yxN_{\beta}</code> matrix.</p>
<p><code>ssm[[&quot;Rm&quot;]]</code> is an <code>N_yxN_y</code> matrix.</p>
<p><code>ssm[[&quot;betaO&quot;]]</code> is an <code>N_yxM_o</code> matrix.</p>
<p><code>ssm[[&quot;betaS&quot;]]</code> is an <code>N_{\beta}xM_s</code>
matrix.</p>
<p>To force exclusion of exogenous data, set the relevant matrices to
have all 0 values.</p>
<p>To use an unweighted likelihood, set the weights to be all 1’s.</p>
<p>To use the package to apply the Kalman filter to data with an
estimated state space model, use the function <code>kalman_filter</code>
as</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">=</span> <span class="fu">kalman_filter</span>(ssm, yt, Xo, Xs, smooth)</span></code></pre></div>
<p>where <code>smooth</code> is a boolean indicating whether to run the
backwards smoother or not.</p>
<div id="example-nelson-siegel-dynamic-factor-yield-curve-model" class="section level2">
<h2>Example: Nelson-Siegel Dynamic Factor Yield Curve Model</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kalmanfilter)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(maxLik)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(treasuries)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>tau <span class="ot">=</span> <span class="fu">unique</span>(treasuries<span class="sc">$</span>maturity)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">#State space model for the Nelson-Siegel dynamic factor yield curve</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>yc_ssm <span class="ot">=</span> <span class="cf">function</span>(par, tau){</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Set factor names</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">=</span> <span class="fu">unique</span>(tau)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  factors <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;l&quot;</span>, <span class="st">&quot;s&quot;</span>, <span class="st">&quot;c&quot;</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Loading on the slope factor</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  Ls <span class="ot">=</span> <span class="cf">function</span>(par, tau){</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="sc">-</span>(<span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span>tau<span class="sc">*</span>par[<span class="st">&quot;lambda&quot;</span>]))<span class="sc">/</span>(tau<span class="sc">*</span>par[<span class="st">&quot;lambda&quot;</span>]))</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Loading on the curvature factor</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  Lc <span class="ot">=</span> <span class="cf">function</span>(par, tau){</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="sc">-</span><span class="fu">Ls</span>(par[<span class="st">&quot;lambda&quot;</span>], tau) <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span>tau<span class="sc">*</span>par[<span class="st">&quot;lambda&quot;</span>]))</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="do">########## Define the state space model</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Transition matrix</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  Fm <span class="ot">=</span> <span class="fu">matrix</span>(par[<span class="fu">grepl</span>(<span class="st">&quot;phi_&quot;</span>, <span class="fu">names</span>(par))], <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">ncol =</span> <span class="dv">3</span>,</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>              <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">paste0</span>(factors, <span class="st">&quot;_t0&quot;</span>),</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">paste0</span>(factors, <span class="st">&quot;_t1&quot;</span>)))</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  Fm[<span class="fu">is.na</span>(Fm)] <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Transition exogenous matrix</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  betaS <span class="ot">=</span> <span class="fu">matrix</span>(par[<span class="fu">grepl</span>(<span class="st">&quot;betaS_&quot;</span>, <span class="fu">names</span>(par))], <span class="at">nrow =</span> <span class="dv">3</span>, </span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>                 <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">rownames</span>(Fm), </span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">unique</span>(<span class="fu">sapply</span>(<span class="fu">names</span>(par)[<span class="fu">grepl</span>(<span class="st">&quot;betaS_&quot;</span>, <span class="fu">names</span>(par))], <span class="cf">function</span>(x){</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>                                   s <span class="ot">=</span> <span class="fu">strsplit</span>(x, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">.&quot;</span>)[[<span class="dv">1</span>]]</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">return</span>(<span class="fu">paste</span>(s[<span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(s)], <span class="at">collapse =</span> <span class="st">&quot;.&quot;</span>))</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>                                 }))))</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Transition intercept matrix</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>  Dm <span class="ot">=</span> <span class="fu">matrix</span>(par[<span class="fu">grepl</span>(<span class="st">&quot;D_&quot;</span>, <span class="fu">names</span>(par))], <span class="at">ncol =</span> <span class="dv">1</span>,</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>              <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">rownames</span>(Fm), <span class="cn">NULL</span>))</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Transition error covariance matrix</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>  Qm <span class="ot">=</span> <span class="fu">matrix</span>(par[<span class="fu">unlist</span>(<span class="fu">lapply</span>(factors, <span class="cf">function</span>(x){<span class="fu">paste0</span>(<span class="st">&quot;sig_&quot;</span>, x, factors)}))], <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>  Qm[<span class="fu">lower.tri</span>(Qm)] <span class="ot">=</span> Qm[<span class="fu">upper.tri</span>(Qm)]</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dimnames</span>(Qm) <span class="ot">=</span> <span class="fu">list</span>(<span class="fu">rownames</span>(Fm), <span class="fu">rownames</span>(Fm))</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Observation equation matrix</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">=</span> <span class="fu">length</span>(tau)</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>  Hm <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> n, <span class="at">ncol =</span> <span class="dv">3</span>, </span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>              <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">as.character</span>(tau), <span class="fu">rownames</span>(Fm)))</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">=</span> <span class="fu">as.numeric</span>(tau)</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="st">&quot;l&quot;</span> <span class="sc">%in%</span> factors){</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    Hm[, <span class="st">&quot;l_t0&quot;</span>] <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="st">&quot;s&quot;</span> <span class="sc">%in%</span> factors){</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    Hm[, <span class="st">&quot;s_t0&quot;</span>] <span class="ot">=</span> <span class="fu">Ls</span>(par, tau)</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="st">&quot;c&quot;</span> <span class="sc">%in%</span> factors){</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    Hm[, <span class="st">&quot;c_t0&quot;</span>] <span class="ot">=</span> <span class="fu">Lc</span>(par, tau)</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>  betaO <span class="ot">=</span> <span class="fu">matrix</span>(par[<span class="fu">grepl</span>(<span class="st">&quot;betaO_&quot;</span>, <span class="fu">names</span>(par))], <span class="at">nrow =</span> n, </span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>                 <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">rownames</span>(Hm), </span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">unique</span>(<span class="fu">sapply</span>(<span class="fu">names</span>(par)[<span class="fu">grepl</span>(<span class="st">&quot;betaO_&quot;</span>, <span class="fu">names</span>(par))], <span class="cf">function</span>(x){</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>                                   s <span class="ot">=</span> <span class="fu">strsplit</span>(x, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">.&quot;</span>)[[<span class="dv">1</span>]]</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">return</span>(<span class="fu">paste</span>(s[<span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(s)], <span class="at">collapse =</span> <span class="st">&quot;.&quot;</span>))</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>                                 }))))</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Observation error variance covariance matrix</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>  Rm <span class="ot">=</span> <span class="fu">diag</span>(<span class="fu">sum</span>(<span class="fu">grepl</span>(<span class="st">&quot;sig_</span><span class="sc">\\</span><span class="st">d+&quot;</span>, <span class="fu">names</span>(par))))<span class="sc">*</span>par[<span class="fu">grepl</span>(<span class="st">&quot;sig_</span><span class="sc">\\</span><span class="st">d+&quot;</span>, <span class="fu">names</span>(par))]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dimnames</span>(Rm) <span class="ot">=</span> <span class="fu">list</span>(<span class="fu">rownames</span>(Hm), <span class="fu">rownames</span>(Hm))</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Observation intercept matrix</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>  Am <span class="ot">=</span> <span class="fu">matrix</span>(par[<span class="fu">grepl</span>(<span class="st">&quot;A_&quot;</span>, <span class="fu">names</span>(par))], <span class="at">nrow =</span> <span class="fu">nrow</span>(Hm), <span class="at">ncol =</span> <span class="dv">1</span>, </span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>              <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">rownames</span>(Hm), <span class="cn">NULL</span>))</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Initial guess for the unobserved vector</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>  B0 <span class="ot">=</span> <span class="fu">matrix</span>(par[<span class="fu">names</span>(par) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;level&quot;</span>, <span class="st">&quot;slope&quot;</span>, <span class="st">&quot;curvature&quot;</span>)], <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(Fm), </span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>              <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">rownames</span>(Fm), <span class="cn">NULL</span>))</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Initial guess for the variance of the unobserved vector</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>  P0 <span class="ot">=</span> <span class="fu">diag</span>(par[<span class="st">&quot;P0&quot;</span>]<span class="sc">^</span><span class="dv">2</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(Qm), <span class="at">ncol =</span> <span class="fu">ncol</span>(Qm))</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Fm =</span> Fm, <span class="at">Dm =</span> Dm, <span class="at">Qm =</span> Qm, </span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>              <span class="at">Hm =</span> Hm, <span class="at">Am =</span> Am, <span class="at">Rm =</span> Rm, </span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>              <span class="at">betaO =</span> betaO, <span class="at">betaS =</span> betaS,</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>              <span class="at">B0 =</span> B0, <span class="at">P0 =</span> P0))</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a><span class="co">#Set the initial values</span></span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>init <span class="ot">=</span> <span class="fu">c</span>(<span class="at">level =</span> <span class="fl">5.73</span>, <span class="at">slope =</span> <span class="sc">-</span><span class="fl">0.46</span>, <span class="at">curvature =</span> <span class="fl">0.67</span>, <span class="at">lambda =</span> <span class="fl">0.04</span>, </span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>         <span class="at">D_l =</span> <span class="fl">0.14</span>, <span class="at">D_s =</span> <span class="sc">-</span><span class="fl">0.08</span>, <span class="at">D_c =</span> <span class="fl">0.24</span>, </span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>         <span class="at">phi_ll =</span> <span class="fl">0.97</span>, <span class="at">phi_ls =</span> <span class="sc">-</span><span class="fl">0.02</span>, <span class="at">phi_lc =</span> <span class="fl">0.01</span>, </span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>         <span class="at">phi_sl =</span> <span class="fl">0.082</span>, <span class="at">phi_ss =</span> <span class="fl">0.79</span>, <span class="at">phi_sc =</span> <span class="sc">-</span><span class="fl">0.14</span>, </span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>         <span class="at">phi_cl =</span> <span class="sc">-</span><span class="fl">0.15</span>, <span class="at">phi_cs =</span> <span class="fl">0.05</span>, <span class="at">phi_cc =</span> <span class="fl">0.88</span>, </span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>         <span class="at">betaS_l.X =</span> <span class="dv">0</span>, <span class="at">betaS_s.X =</span> <span class="dv">0</span>, <span class="at">betaS_c.X =</span> <span class="dv">0</span>, </span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>         <span class="at">sig_ll =</span> <span class="fl">0.13</span>, </span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>         <span class="at">sig_sl =</span> <span class="fl">0.12</span>, <span class="at">sig_ss =</span> <span class="fl">0.24</span>,</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>         <span class="at">sig_cl =</span> <span class="sc">-</span><span class="fl">0.05</span>, <span class="at">sig_cs =</span> <span class="sc">-</span><span class="fl">0.08</span>, <span class="at">sig_cc =</span> <span class="fl">1.03</span>, </span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>         <span class="at">A_1 =</span> <span class="dv">0</span>, <span class="at">A_3 =</span> <span class="dv">0</span>, <span class="at">A_6 =</span> <span class="dv">0</span>, <span class="at">A_12 =</span> <span class="dv">0</span>, <span class="at">A_24 =</span> <span class="dv">0</span>, </span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>         <span class="at">A_36 =</span> <span class="dv">0</span>, <span class="at">A_60 =</span> <span class="dv">0</span>, <span class="at">A_84 =</span> <span class="dv">0</span>, <span class="at">A_120 =</span> <span class="dv">0</span>, <span class="at">A_240 =</span> <span class="dv">0</span>, <span class="at">A_360 =</span> <span class="dv">0</span>, </span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>         <span class="at">betaO_1.X =</span> <span class="dv">0</span>, <span class="at">betaO_3.X =</span> <span class="dv">0</span>, <span class="at">betaO_6.X =</span> <span class="dv">0</span>, <span class="at">betaO_12.X =</span> <span class="dv">0</span>, </span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>         <span class="at">betaO_24.X =</span> <span class="dv">0</span>, <span class="at">betaO_36.X =</span> <span class="dv">0</span>, <span class="at">betaO_60.X =</span> <span class="dv">0</span>, <span class="at">betaO_84.X =</span> <span class="dv">0</span>, </span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>         <span class="at">betaO_120.X =</span> <span class="dv">0</span>, <span class="at">betaO_240.X =</span> <span class="dv">0</span>, <span class="at">betaO_360.X =</span> <span class="dv">0</span>, </span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>         <span class="at">sig_1 =</span> <span class="fl">0.08</span>, <span class="at">sig_3 =</span> <span class="fl">0.01</span>, <span class="at">sig_6 =</span> <span class="fl">0.11</span>, <span class="at">sig_12 =</span> <span class="fl">0.12</span>, </span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>         <span class="at">sig_24 =</span> <span class="fl">0.07</span>, <span class="at">sig_36 =</span> <span class="fl">0.01</span>, <span class="at">sig_60 =</span> <span class="fl">0.06</span>, <span class="at">sig_84 =</span> <span class="fl">0.07</span>, </span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>         <span class="at">sig_120 =</span> <span class="fl">0.04</span>, <span class="at">sig_240 =</span> <span class="fl">0.18</span>, <span class="at">sig_360 =</span> <span class="fl">0.2</span>, </span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>         <span class="at">P0 =</span> <span class="fl">0.01</span>)</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a><span class="co">#Define the fixed values: not using exogenous data or observation intercept</span></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>fixed <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;betaS_l.x&quot;</span>, <span class="st">&quot;betaS_s.X&quot;</span>, <span class="st">&quot;betaS_c.X&quot;</span>, </span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;A_1&quot;</span>, <span class="st">&quot;A_3&quot;</span>, <span class="st">&quot;A_6&quot;</span>, <span class="st">&quot;A_12&quot;</span>, <span class="st">&quot;A_24&quot;</span>, <span class="st">&quot;A_36&quot;</span>, <span class="st">&quot;A_60&quot;</span>, </span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;A_84&quot;</span>, <span class="st">&quot;A_120&quot;</span>, <span class="st">&quot;A_240&quot;</span>, <span class="st">&quot;A_360&quot;</span>, </span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;betaO_1.X&quot;</span>, <span class="st">&quot;betaO_3.X&quot;</span>, <span class="st">&quot;betaO_6.X&quot;</span>, <span class="st">&quot;betaO_12.X&quot;</span>, </span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;betaO_24.X&quot;</span>, <span class="st">&quot;betaO_36.X&quot;</span>, <span class="st">&quot;betaO_60.X&quot;</span>, <span class="st">&quot;betaO_84.X&quot;</span>, </span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;betaO_120.X&quot;</span>, <span class="st">&quot;betaO_240.X&quot;</span>, <span class="st">&quot;betaO_360.X&quot;</span>)</span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a><span class="co">#Set up the constraints: lambda and all standard deviation parameters must be positive</span></span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>ineqA <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">15</span>, <span class="at">ncol =</span> <span class="fu">length</span>(init), <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="cn">NULL</span>, <span class="fu">names</span>(init)))</span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(ineqA[, <span class="fu">c</span>(<span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;sig_ll&quot;</span>, <span class="st">&quot;sig_ss&quot;</span>, <span class="st">&quot;sig_cc&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;sig_&quot;</span>, tau))]) <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>ineqB <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(ineqA), <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a><span class="co">#Convert to an NxT matrix</span></span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>yt <span class="ot">=</span> <span class="fu">dcast</span>(treasuries, <span class="st">&quot;date ~ maturity&quot;</span>, <span class="at">value.var =</span> <span class="st">&quot;value&quot;</span>)</span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>yt <span class="ot">=</span> <span class="fu">t</span>(yt[, <span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(yt)])</span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a><span class="co">#Set the objective function</span></span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>objective <span class="ot">=</span> <span class="cf">function</span>(par, data){</span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>  ssm <span class="ot">=</span> <span class="fu">yc_ssm</span>(par, <span class="fu">unique</span>(data<span class="sc">$</span>maturity))</span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">kalman_lik</span>(ssm, yt))</span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a><span class="co">#Solve the model</span></span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>solve <span class="ot">=</span> <span class="fu">maxLik</span>(<span class="at">logLik =</span> objective,</span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>               <span class="at">start =</span> init, <span class="at">method =</span> <span class="st">&quot;BFGS&quot;</span>,</span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>               <span class="at">finalHessian =</span> <span class="cn">FALSE</span>, <span class="at">hess =</span> <span class="cn">NULL</span>,</span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>               <span class="at">control =</span> <span class="fu">list</span>(<span class="at">printLevel =</span> <span class="dv">2</span>, <span class="at">iterlim =</span> <span class="dv">10000</span>), </span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>               <span class="at">constraints =</span> <span class="fu">list</span>(<span class="at">ineqA =</span> ineqA, <span class="at">ineqB =</span> ineqB), </span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> treasuries, <span class="at">fixed =</span> fixed)</span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a><span class="co">#Get the estimated state space model</span></span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a>ssm <span class="ot">=</span> <span class="fu">yc_ssm</span>(solve<span class="sc">$</span>estimate, tau)</span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a><span class="co">#Filter the data with the model</span></span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>filter <span class="ot">=</span> <span class="fu">kalman_filter</span>(ssm, yt, <span class="at">smooth =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a><span class="co">#Get the estimated unobserved factors</span></span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a>B_tt <span class="ot">=</span> <span class="fu">data.table</span>(<span class="fu">t</span>(filter[[<span class="st">&quot;B_tt&quot;</span>]]))[, <span class="st">&quot;date&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">unique</span>(treasuries<span class="sc">$</span>date)]</span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(B_tt)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>] <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;level&quot;</span>, <span class="st">&quot;slope&quot;</span>, <span class="st">&quot;curvature&quot;</span>)</span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a><span class="co">#Get the estimated yields</span></span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>y_tt <span class="ot">=</span> <span class="fu">data.table</span>(<span class="fu">t</span>(filter[[<span class="st">&quot;y_tt&quot;</span>]]))[, <span class="st">&quot;date&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">unique</span>(treasuries<span class="sc">$</span>date)]</span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(y_tt)[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">ncol</span>(y_tt) <span class="sc">-</span> <span class="dv">1</span>)] <span class="ot">=</span> tau</span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a><span class="co">#Plot the data</span></span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">=</span> <span class="fu">ggplot</span>(treasuries, <span class="at">id.vars =</span> <span class="st">&quot;date&quot;</span>) <span class="sc">+</span> </span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">group =</span> <span class="fu">factor</span>(maturity), <span class="at">color =</span> <span class="fu">factor</span>(maturity))) <span class="sc">+</span> </span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) <span class="sc">+</span></span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Actual Treasury Yields&quot;</span>, <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;value&quot;</span>) <span class="sc">+</span> </span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>))</span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="fu">melt</span>(y_tt, <span class="at">id.vars =</span> <span class="st">&quot;date&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">group =</span> variable, <span class="at">color =</span> variable)) <span class="sc">+</span> </span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) <span class="sc">+</span></span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Estimated Treasury Yields&quot;</span>, <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;value&quot;</span>) <span class="sc">+</span> </span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>))</span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a>g3 <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="fu">melt</span>(B_tt, <span class="at">id.vars =</span> <span class="st">&quot;date&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">group =</span> variable, <span class="at">color =</span> variable)) <span class="sc">+</span> </span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) <span class="sc">+</span></span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Estimated Factors&quot;</span>, <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;value&quot;</span>) <span class="sc">+</span> </span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>))</span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(g1, g2, g3, <span class="at">layout_matrix =</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>)))</span></code></pre></div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
